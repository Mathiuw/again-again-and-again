[gd_scene load_steps=9 format=3 uid="uid://dquef6xj016ys"]

[ext_resource type="PackedScene" uid="uid://v6scm44jqtat" path="res://scene/player.tscn" id="1_itxqv"]
[ext_resource type="PackedScene" uid="uid://b24q0q78wlx5d" path="res://scene/hud.tscn" id="2_p1hux"]
[ext_resource type="Script" uid="uid://bvibwp2q2iop7" path="res://script/player_Camera.gd" id="3_wp4xf"]
[ext_resource type="PackedScene" uid="uid://c5hxh0i0l2p4i" path="res://scene/room/room_rome_02.tscn" id="4_4j5ol"]
[ext_resource type="PackedScene" uid="uid://c6m28at08ltqy" path="res://scene/room/room_rome_01.tscn" id="5_p1hux"]
[ext_resource type="PackedScene" uid="uid://bbdklpf1hb3ar" path="res://scene/room/room_start.tscn" id="6_p1hux"]

[sub_resource type="GDScript" id="GDScript_0ha60"]
resource_name = "main"
script/source = "extends Node

func _ready() -> void:
	PauseManager.can_pause_input = true
"

[sub_resource type="GDScript" id="GDScript_4j5ol"]
resource_name = "loop_timer"
script/source = "extends Timer

var loop_amount: int = 0

func _ready() -> void:
	load_game()
	
	var player: Player = get_tree().get_first_node_in_group(\"player\")
	if  player:
		player.on_player_die.connect(func():
			end_loop()
			)
	
	print(\"Loop started\")
	
	RoomManager.on_room_change.connect(func(room: Room, _smooth_transition: bool):
		if  room.pause_timer:
			paused = true
		else:
			paused = false
		)

func save()-> Dictionary :
	var save_dict = {
		\"loop_amount\": loop_amount
	}
	
	return save_dict

func end_loop() -> void:
	loop_amount += 1
	save_game()
	get_tree().reload_current_scene()
	print(\"Loop ended\")

func save_game() -> void :
	var save_file: FileAccess = FileAccess.open(\"user://savegame.save\", FileAccess.WRITE)
	var save_data: Dictionary = save()
	
	var json_string = JSON.stringify(save_data)
	save_file.store_line(json_string)

func load_game() -> void:
	if !FileAccess.file_exists(\"user://savegame.save\"):
		return # No save file found
	
	var save_file: FileAccess = FileAccess.open(\"user://savegame.save\", FileAccess.READ)
	while save_file.get_position() < save_file.get_length():
		var json_string = save_file.get_line()
		
		var json = JSON.new()
		
		var parse_result = json.parse(json_string)
		
		if not parse_result == OK:
			push_error(\"JSON parse error\")
			continue
		
		var node_data = json.data
		
		loop_amount = node_data[\"loop_amount\"]
"

[node name="Main" type="Node" groups=["world"]]
script = SubResource("GDScript_0ha60")

[node name="LoopTimer" type="Timer" parent="." groups=["loop_timer"]]
wait_time = 360.0
one_shot = true
autostart = true
script = SubResource("GDScript_4j5ol")

[node name="CanvasLayer" type="CanvasLayer" parent="."]

[node name="HUD" parent="CanvasLayer" instance=ExtResource("2_p1hux")]

[node name="Map" type="Node2D" parent="."]
y_sort_enabled = true
metadata/_edit_lock_ = true

[node name="Room_Start" parent="Map" instance=ExtResource("6_p1hux")]

[node name="DoorRight" parent="Map/Room_Start" index="2" node_paths=PackedStringArray("desired_room")]
desired_room = NodePath("../../Room_Rome_01")

[node name="DesiredPosition" parent="Map/Room_Start/DoorRight" index="3"]
position = Vector2(-62, 2.99984)

[node name="Room_Rome_01" parent="Map" instance=ExtResource("5_p1hux")]
position = Vector2(640, 0)

[node name="DoorLeft" parent="Map/Room_Rome_01" index="1" node_paths=PackedStringArray("desired_room")]
desired_room = NodePath("../../Room_Start")

[node name="DesiredPosition" parent="Map/Room_Rome_01/DoorLeft" index="3"]
position = Vector2(-64, -2)

[node name="DoorRight" parent="Map/Room_Rome_01" index="2" node_paths=PackedStringArray("desired_room")]
desired_room = NodePath("../../Room_Rome_02")

[node name="DesiredPosition" parent="Map/Room_Rome_01/DoorRight" index="3"]
position = Vector2(-55.999985, -6.000142)

[node name="Room_Rome_02" parent="Map" instance=ExtResource("4_4j5ol")]
position = Vector2(1280, 0)

[node name="DoorLeft" parent="Map/Room_Rome_02" index="2" node_paths=PackedStringArray("desired_room")]
desired_room = NodePath("../../Room_Rome_01")

[node name="DesiredPosition" parent="Map/Room_Rome_02/DoorLeft" index="3"]
position = Vector2(-56.000053, 5.9995027)

[node name="Player" parent="Map" groups=["enemy"] instance=ExtResource("1_itxqv")]
position = Vector2(-184, 16)

[node name="PlayerCamera" type="Camera2D" parent="." groups=["camera"]]
position_smoothing_enabled = true
position_smoothing_speed = 10.0
script = ExtResource("3_wp4xf")

[connection signal="timeout" from="LoopTimer" to="LoopTimer" method="_on_timeout"]

[editable path="Map/Room_Start"]
[editable path="Map/Room_Start/DoorRight"]
[editable path="Map/Room_Rome_01"]
[editable path="Map/Room_Rome_01/DoorLeft"]
[editable path="Map/Room_Rome_01/DoorRight"]
[editable path="Map/Room_Rome_02"]
[editable path="Map/Room_Rome_02/DoorRight"]
[editable path="Map/Room_Rome_02/DoorLeft"]
